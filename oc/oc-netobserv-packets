#!/bin/bash
source "./scripts/functions.sh"

# pcap filter such as 'tcp,80'
filter=$1

if [ -z "$filter" ]
then
  echo "Specify a valid filter as first argument such as 'oc get-packets tcp,80'"
  exit 1
fi

trap cleanup EXIT

setup packets $filter

echo "\nRunning network-observability-cli get-packets... "
oc run \
  -n netobserv-cli \
  collector \
  --image=quay.io/jpinsonn/network-observability-cli:dev \
  --image-pull-policy='Always' \
  --restart='Never' \
  --command -- sleep infinity

oc wait \
  -n netobserv-cli \
  --for=condition=Ready pod/collector

oc exec -i --tty \
  -n netobserv-cli \
  collector \
  -- /network-observability-cli get-packets --filter "$filter"